name: Policy Guard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required files exist
        run: |
          missing=0

          must_have=("POLICY.md" "CITATION.cff")
          optional=("ANCHOR.json")

          echo "üîé Checking must-have files..."
          for f in "${must_have[@]}"; do
            if [ ! -f "$f" ]; then
              echo "‚ùå Missing required file: $f"
              missing=1
            else
              echo "‚úÖ Found $f"
            fi
          done

          echo "‚ÑπÔ∏è Optional files (recommended): ${optional[*]}"
          for f in "${optional[@]}"; do
            if [ -f "$f" ]; then
              echo "‚úÖ Found optional $f"
            else
              echo "‚ö†Ô∏è Optional file not present: $f"
            fi
          done

          if [ $missing -ne 0 ]; then
            echo ""
            echo "üìù Fix tips:"
            echo "  - Add POLICY.md (usage & attribution policy)."
            echo "  - Add CITATION.cff (author + DOI metadata)."
            echo "  - (Optional) Add ANCHOR.json for machine-readable scope."
            exit 1
          fi

      - name: Brief lint for POLICY.md anchors
        if: always()
        run: |
          if [ -f POLICY.md ]; then
            grep -q -i "Allowed" POLICY.md && echo "‚úÖ POLICY.md contains Allowed section" || echo "‚ö†Ô∏è Consider adding an 'Allowed' section"
            grep -q -i "Forbidden" POLICY.md && echo "‚úÖ POLICY.md contains Forbidden section" || echo "‚ö†Ô∏è Consider adding a 'Forbidden' section"
          fi
